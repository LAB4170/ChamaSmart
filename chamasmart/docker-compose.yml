# ============================================================================
# DOCKER COMPOSE REFERENCE - USE WITH .env.local FILE
# ============================================================================
# INSTRUCTIONS:
# 1. Copy this to docker-compose.yml (if needed)
# 2. Copy .env.example to .env.local
# 3. Fill in actual values in .env.local
# 4. Run: docker-compose up -d
# 5. NEVER commit .env or docker-compose with hardcoded secrets
#
# All secrets are loaded from .env.local using ${VARIABLE_NAME} syntax
# ============================================================================

version: "3.8"

services:
  # ============================================================================
  # DATABASE SERVICE - PostgreSQL
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: chamasmart_db
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me}
      POSTGRES_DB: ${DB_NAME:-chamasmart}
      POSTGRES_INITDB_ARGS: "-c max_connections=${DB_POOL_MAX:-20}"
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    ports:
      - "${DB_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database_schema.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-chamasmart}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - chamasmart_net
    restart: unless-stopped

  # ============================================================================
  # REDIS SERVICE - Caching & Rate Limiting
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: chamasmart_redis
    environment:
      # Redis requires password from CLI
      REDIS_PASSWORD: ${REDIS_PASSWORD:-change_me}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command:
      - redis-server
      - "--requirepass"
      - "${REDIS_PASSWORD:-change_me}"
      - "--appendonly"
      - "yes"
      - "--appendfsync"
      - "everysec"
      - "--timeout"
      - "300"
      - "--tcp-keepalive"
      - "60"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - chamasmart_net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

  # ============================================================================
  # BACKEND SERVICE - Node.js Application
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: chamasmart_backend
    env_file:
      - .env.local
    ports:
      - "${PORT:-5000}:5000"
    environment:
      # Application Configuration
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-5000}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Database Configuration
      DB_USER: ${DB_USER:-postgres}
      DB_HOST: postgres
      DB_NAME: ${DB_NAME:-chamasmart}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT:-5432}
      DB_POOL_MAX: ${DB_POOL_MAX:-20}

      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # JWT & Security
      JWT_SECRET_V1: ${JWT_SECRET_V1}
      JWT_SECRET_V2: ${JWT_SECRET_V2}
      JWT_KEY_VERSION: ${JWT_KEY_VERSION:-1}
      SESSION_SECRET: ${SESSION_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}

      # Email Configuration
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}

      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-5000}
      AUTH_RATE_LIMIT_MAX: ${AUTH_RATE_LIMIT_MAX:-3}

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-5000}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    volumes:
      - ./backend:/usr/src/app
      - /usr/src/app/node_modules
      - backend_logs:/usr/src/app/logs

    networks:
      - chamasmart_net

    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  # ============================================================================
  # FRONTEND SERVICE - React Application (Optional)
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: chamasmart_frontend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      REACT_APP_API_URL: http://localhost:${PORT:-5000}
      REACT_APP_WS_URL: ws://localhost:${PORT:-5000}
    depends_on:
      - backend
    networks:
      - chamasmart_net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

# ============================================================================
# VOLUMES - Data Persistence
# ============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  backend_logs:
    driver: local

# ============================================================================
# NETWORKS - Service Communication
# ============================================================================
networks:
  chamasmart_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
# 1. PRODUCTION: Use docker-compose.prod.yml with:
#    - restart policies
#    - resource limits
#    - logging drivers
#    - volume backups
#
# 2. SECURITY CHECKLIST:
#    - [ ] All secrets in .env.local (not committed)
#    - [ ] .env.local in .gitignore
#    - [ ] Unique strong passwords for all services
#    - [ ] SSL/TLS certificates generated and mounted
#    - [ ] Network policies configured
#    - [ ] Regular backups scheduled
#
# 3. COMMANDS:
#    Start: docker-compose up -d
#    Stop: docker-compose down
#    Logs: docker-compose logs -f backend
#    Restart: docker-compose restart backend
#    Remove data: docker-compose down -v
