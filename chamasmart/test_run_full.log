
> chamasmart@1.0.0 test
> npm run test:backend --no-coverage --maxWorkers=1

npm warn Unknown cli config "--coverage". This will stop working in the next major version of npm.
npm warn Unknown cli config "--maxWorkers". This will stop working in the next major version of npm.

> chamasmart@1.0.0 test:backend
> cd backend && npm test

npm warn Unknown env config "maxworkers". This will stop working in the next major version of npm.

> chamasmart-backend@1.0.0 test
> jest --runInBand

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 69.960 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 19.427 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 25.826 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 19.560 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 14.353 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
POST /api/auth/register 400 4.377 ms - anonymous - {"email":"invalid-email","password":"[REDACTED]","name":"Test User"}
POST /api/auth/register 400 1.519 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]","name":"Test User"}
POST /api/auth/login 400 1.523 ms - anonymous - {"email":{"$ne":null},"password":"[REDACTED]"}
POST /api/chamas 401 1.326 ms - anonymous - {"name":"Test <script>alert(1)</script>","description":"Description <script>alert(1)</script>"}
FAIL tests/security.test.js
  Security Middleware
    Rate Limiting
      Î“ÃªÃœ should allow requests under the rate limit (331 ms)
      Î“ÃªÃœ should block requests over the rate limit
    Security Headers
      â”œÃ¹ should include security headers (12 ms)
    Input Validation
      â”œÃ¹ should reject invalid email format (18 ms)
      Î“ÃªÃœ should reject weak passwords (15 ms)
    NoSQL Injection Protection
      Î“ÃªÃœ should sanitize NoSQL injection attempts (15 ms)
    XSS Protection
      Î“ÃªÃœ should sanitize XSS attempts in request body (9 ms)

  Î“Ã¹Ã… Security Middleware Î“Ã‡â•‘ Security Headers Î“Ã‡â•‘ should include security headers

    expect(received).toBe(expected) // Object.is equality

    Expected: "off"
    Received: undefined

      62 |       const response = await request(server).get("/health");
      63 |
    > 64 |       expect(response.headers["x-dns-prefetch-control"]).toBe("off");
         |                                                          ^
      65 |       expect(response.headers["x-frame-options"]).toBe("DENY");
      66 |       expect(response.headers["strict-transport-security"]).toBeDefined();
      67 |       expect(response.headers["x-download-options"]).toBe("noopen");

      at Object.toBe (tests/security.test.js:64:58)

  Î“Ã¹Ã… Security Middleware Î“Ã‡â•‘ Input Validation Î“Ã‡â•‘ should reject invalid email format

    expect(received).toHaveProperty(path, value)

    Expected path: "message"

    Expected value: "Validation failed"
    Received value: "Validation error"

      82 |       expect(response.status).toBe(400);
      83 |       expect(response.body).toHaveProperty("success", false);
    > 84 |       expect(response.body).toHaveProperty("message", "Validation failed");
         |                             ^
      85 |     });
      86 |
      87 |     it("should reject weak passwords", async () => {

      at Object.toHaveProperty (tests/security.test.js:84:29)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

FAIL tests/socketAuth.test.js
  Socket.io authentication
    â”œÃ¹ rejects connection without token (119 ms)

  Î“Ã¹Ã… Socket.io authentication Î“Ã‡â•‘ rejects connection without token

    expect(received).toBe(expected) // Object.is equality

    Expected: "Authentication error"
    Received: "websocket error"

      33 |       await connect();
      34 |     } catch (err) {
    > 35 |       expect(err.message).toBe('Authentication error');
         |                           ^
      36 |     }
      37 |   });
      38 | });

      at Object.toBe (tests/socketAuth.test.js:35:27)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    ASCA unit test buyShares error: TypeError: Cannot read properties of undefined (reading 'query')
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\ascaController.js:79:18)
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\ascaController.test.js:139:5)

      at Object.log (tests/ascaController.test.js:143:15)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

FAIL tests/ascaController.test.js
  ASCA Controller - buyShares
    Î“ÃªÃœ rejects invalid payment method (3 ms)
    â”œÃ¹ creates share purchase with valid payment method and computes shares (35 ms)
  ASCA Controller - getMyEquity
    Î“ÃªÃœ computes equity based on total assets and shares (2 ms)

  Î“Ã¹Ã… ASCA Controller - buyShares Î“Ã‡â•‘ creates share purchase with valid payment method and computes shares

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 201

    Number of calls: 0

      144 |     }
      145 |
    > 146 |     expect(res.status).toHaveBeenCalledWith(201);
          |                        ^
      147 |     const payload = res.json.mock.calls[0][0];
      148 |
      149 |     expect(payload.success).toBe(true);

      at Object.toHaveBeenCalledWith (tests/ascaController.test.js:146:24)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

  console.error
    SERVER ERROR: Cannot read properties of undefined (reading 'query')

    [0m [90m 212 |[39m app[33m.[39muse((err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
     [90m 213 |[39m   err[33m.[39mstatusCode [33m=[39m err[33m.[39mstatusCode [33m||[39m [35m500[39m[33m;[39m
    [31m[1m>[22m[39m[90m 214 |[39m   console[33m.[39merror([32m"SERVER ERROR:"[39m[33m,[39m err[33m.[39mmessage)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 215 |[39m   logger[33m.[39merror({
     [90m 216 |[39m     message[33m:[39m err[33m.[39mmessage[33m,[39m
     [90m 217 |[39m     stack[33m:[39m err[33m.[39mstack[33m,[39m[0m

      at error (server.js:214:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (controllers/ascaController.js:151:12)

POST /api/asca/1/buy-shares 500 28.578 ms - 10 - {"amount":1000,"paymentMethod":"mpesa"}
GET /api/asca/1/equity 200 4.714 ms - 10 - -
FAIL tests/ascaRoutes.int.test.js
  ASCA routes integration (/api/asca)
    â”œÃ¹ POST /api/asca/:chamaId/buy-shares creates a share purchase with normalized payment method (95 ms)
    Î“ÃªÃœ GET /api/asca/:chamaId/equity returns computed equity snapshot (24 ms)

  Î“Ã¹Ã… ASCA routes integration (/api/asca) Î“Ã‡â•‘ POST /api/asca/:chamaId/buy-shares creates a share purchase with normalized payment method

    expected 201 "Created", got 500 "Internal Server Error"

      128 |       .set('Authorization', 'Bearer fake-token')
      129 |       .send({ amount: 1000, paymentMethod: 'mpesa' })
    > 130 |       .expect(201);
          |        ^
      131 |
      132 |     expect(res.body.success).toBe(true);
      133 |     expect(res.body.data.sharePrice).toBe(100);

      at Object.expect (tests/ascaRoutes.int.test.js:130:8)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

FAIL tests/roscaController.test.js
  ROSCA createCycle - parameterized roster insert
    â”œÃ¹ uses parameterized VALUES and correct payout amounts (1 ms)
  ROSCA processPayout - contribution checks
    â”œÃ¹ rejects payout when not all members have paid (2 ms)
    â”œÃ¹ allows payout when all members have paid at least contribution_amount (1 ms)

  Î“Ã¹Ã… ROSCA createCycle - parameterized roster insert Î“Ã‡â•‘ uses parameterized VALUES and correct payout amounts

    TypeError: Cannot read properties of undefined (reading 'release')

      167 |         });
      168 |     } finally {
    > 169 |         client.release();
          |                ^
      170 |     }
      171 | };
      172 |

      at release (controllers/roscaController.js:169:16)
      at Object.<anonymous> (tests/roscaController.test.js:89:5)

  Î“Ã¹Ã… ROSCA processPayout - contribution checks Î“Ã‡â•‘ rejects payout when not all members have paid

    TypeError: Cannot read properties of undefined (reading 'release')

      450 |         });
      451 |     } finally {
    > 452 |         client.release();
          |                ^
      453 |     }
      454 | };
      455 |

      at release (controllers/roscaController.js:452:16)
      at Object.<anonymous> (tests/roscaController.test.js:170:5)

  Î“Ã¹Ã… ROSCA processPayout - contribution checks Î“Ã‡â•‘ allows payout when all members have paid at least contribution_amount

    TypeError: Cannot read properties of undefined (reading 'release')

      450 |         });
      451 |     } finally {
    > 452 |         client.release();
          |                ^
      453 |     }
      454 | };
      455 |

      at release (controllers/roscaController.js:452:16)
      at Object.<anonymous> (tests/roscaController.test.js:248:5)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

PASS tests/metrics.test.js
  /metrics protection
    Î“ÃªÃœ rejects unauthorized metrics access when token is set in production (49 ms)
    Î“ÃªÃœ allows metrics access with correct token in production (17 ms)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

POST /api/auth/register 201 231.407 ms - anonymous - {"email":"test1768832537151@example.com","password":"[REDACTED]","firstName":"Test","lastName":"User","phoneNumber":"0712345678"}
POST /api/auth/register 400 1.376 ms - anonymous - {"email":"test@example.com"}
POST /api/auth/register 400 1.434 ms - anonymous - {"email":"duplicate1768832537515@example.com","password":"[REDACTED]","firstName":"Test","lastName":"User","phoneNumber":"0712345678"}
  console.log
    Querying database for user: logintest1768832537547@example.com

      at log (controllers/authController.js:263:13)

  console.log
    Database query result: { rowCount: 1 }

      at log (controllers/authController.js:267:13)

POST /api/auth/login 200 40.550 ms - anonymous - {"email":"logintest1768832537547@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: logintest1768832537547@example.com

      at log (controllers/authController.js:263:13)

  console.log
    Database query result: { rowCount: 1 }

      at log (controllers/authController.js:267:13)

POST /api/auth/login 401 18.243 ms - anonymous - {"email":"logintest1768832537547@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: nonexistent@example.com

      at log (controllers/authController.js:263:13)

  console.log
    Database query result: { rowCount: 0 }

      at log (controllers/authController.js:267:13)

POST /api/auth/login 401 11.796 ms - anonymous - {"email":"nonexistent@example.com","password":"[REDACTED]"}
PASS tests/auth.test.js
  Authentication API
    POST /api/auth/register
      Î“ÃªÃœ should register a new user (313 ms)
      Î“ÃªÃœ should reject registration with missing fields (47 ms)
      Î“ÃªÃœ should reject duplicate email (33 ms)
    POST /api/auth/login
      Î“ÃªÃœ should login with correct credentials (103 ms)
      Î“ÃªÃœ should reject login with wrong password (106 ms)
      Î“ÃªÃœ should reject login with non-existent email (57 ms)
  Health Check API
    Î“ÃªÃœ should return health status (14 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.error
    AUTH_REGISTER_ERROR: DB connection failed Error: DB connection failed
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:23:13)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:305:39
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:312:13)
        at Object.mockConstructor [as query] (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:102:19)
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:120:35)
        at Object.register (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:37:11)
        at Promise.finally.completed (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at _runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:275:16)
        at runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 225 |[39m     })[33m;[39m
     [90m 226 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 227 |[39m     console[33m.[39merror([32m"AUTH_REGISTER_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 228 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 229 |[39m       context[33m:[39m [32m"auth_register"[39m[33m,[39m
     [90m 230 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:227:13)
      at Object.register (tests/authErrors.test.js:37:11)

  console.error
    AUTH_REGISTER_ERROR: DB connection failed Error: DB connection failed
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:48:13)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:305:39
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:312:13)
        at Object.mockConstructor [as query] (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:102:19)
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:120:35)
        at Object.register (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:62:11)
        at Promise.finally.completed (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at _runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:275:16)
        at runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 225 |[39m     })[33m;[39m
     [90m 226 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 227 |[39m     console[33m.[39merror([32m"AUTH_REGISTER_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 228 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 229 |[39m       context[33m:[39m [32m"auth_register"[39m[33m,[39m
     [90m 230 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:227:13)
      at Object.register (tests/authErrors.test.js:62:11)

  console.log
    Querying database for user: login@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: DB connection failed Error: DB connection failed
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:73:13)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:305:39
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:312:13)
        at Object.mockConstructor [as query] (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:102:19)
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:264:31)
        at Object.login (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:84:11)
        at Promise.finally.completed (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at _runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:275:16)
        at runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)
      at Object.login (tests/authErrors.test.js:84:11)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/authErrors.test.js
  Auth controller error handling
    Î“ÃªÃœ hides internal error details in production for register (52 ms)
    Î“ÃªÃœ includes error details in non-production for register (53 ms)
    Î“ÃªÃœ hides internal error details in production for login (10 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/authVerification.test.js
  Auth verification endpoints
    verifyEmail
      Î“ÃªÃœ rejects missing token (17 ms)
      Î“ÃªÃœ verifies email with valid token (1 ms)
    verifyPhone
      Î“ÃªÃœ rejects missing code (1 ms)
      Î“ÃªÃœ verifies phone with correct OTP and not expired (2 ms)
    resendEmailVerification
      Î“ÃªÃœ returns 404 when user not found (1 ms)
      Î“ÃªÃœ enforces cooldown when last sent recently
      Î“ÃªÃœ resends when outside cooldown window (2 ms)
    resendPhoneVerification
      Î“ÃªÃœ returns 404 when user not found (1 ms)
      Î“ÃªÃœ enforces cooldown when last SMS sent recently (1 ms)
      Î“ÃªÃœ resends OTP when outside cooldown window (1 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/proposalController.test.js
  ProposalController.castVote - membership-checked voting
    Î“ÃªÃœ rejects vote from non-member (10 ms)
    Î“ÃªÃœ allows member to vote once and rejects duplicate votes (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

PASS tests/requestLogger.test.js
  Request Logger Middleware
    sanitizeBody
      Î“ÃªÃœ should redact password field (3 ms)
      Î“ÃªÃœ should redact multiple sensitive fields (1 ms)
      Î“ÃªÃœ should handle null/undefined body (3 ms)
    sanitizeHeaders
      Î“ÃªÃœ should partially redact authorization header (2 ms)
      Î“ÃªÃœ should redact cookie header (2 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

GET /api/rosca/cycles/123/roster 403 4.740 ms - 999 - -
GET /api/rosca/cycles/123/roster 200 3.177 ms - 999 - -
PASS tests/roscaRoutes.int.test.js
  ROSCA routes integration - roster security
    Î“ÃªÃœ denies roster access for non-member (403) (93 ms)
    Î“ÃªÃœ authorized member can see roster without PII (no phone_number/trust_score) (78 ms)

Test Suites: 5 failed, 7 passed, 12 total
Tests:       8 failed, 39 passed, 47 total
Snapshots:   0 total
Time:        20.801 s, estimated 80 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
