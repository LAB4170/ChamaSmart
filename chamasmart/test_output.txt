
> chamasmart@1.0.0 test
> npm run test:backend --no-coverage --runInBand

npm warn Unknown cli config "--coverage". This will stop working in the next major version of npm.
npm warn Unknown cli config "--runInBand". This will stop working in the next major version of npm.

> chamasmart@1.0.0 test:backend
> cd backend && npm test

npm warn Unknown env config "runinband". This will stop working in the next major version of npm.

> chamasmart-backend@1.0.0 test
> jest --runInBand

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    rosca test - db.connect isMock: true

      at Object.log (tests/roscaController.test.js:19:9)

  console.log
    rosca test - db.connect impl: async () => ({
      query: db.__mockClientQuery,
      release: jest.fn()
    })

      at Object.log (tests/roscaController.test.js:21:9)

  console.log
    DEBUG rosca test client: true [ 'query', 'release' ]

      at Object.log (tests/roscaController.test.js:111:13)

  console.log
    DEBUG rosca payout test client: true [ 'query', 'release' ]

      at Object.log (tests/roscaController.test.js:203:13)

  console.log
    DEBUG rosca payout happy-path client: true [ 'query', 'release' ]

      at Object.log (tests/roscaController.test.js:295:13)

  console.error
    [ROSCA PAYOUT] Unexpected query: UPDATE rosca_cycles 
                     SET status = 'COMPLETED', end_date = NOW() 
                     WHERE cycle_id = $1

    [0m [90m 287 |[39m       [90m// Log unexpected queries for debugging[39m
     [90m 288 |[39m       [90m// eslint-disable-next-line no-console[39m
    [31m[1m>[22m[39m[90m 289 |[39m       console[33m.[39merror([32m`[ROSCA PAYOUT] Unexpected query: ${text.substring(0, 120)}`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 290 |[39m       [36mthrow[39m [36mnew[39m [33mError[39m([32m`Unexpected query in happy-path payout test: ${text.substring(0, 200)}`[39m)[33m;[39m
     [90m 291 |[39m     })[33m;[39m
     [90m 292 |[39m[0m

      at Object.error (tests/roscaController.test.js:289:15)
      at query (controllers/roscaController.js:406:26)
      at Object.<anonymous> (tests/roscaController.test.js:298:5)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

FAIL tests/roscaController.test.js (10.105 s)
  ROSCA createCycle - parameterized roster insert
    Î“ÃªÃœ uses parameterized VALUES and correct payout amounts (25 ms)
  ROSCA processPayout - contribution checks
    Î“ÃªÃœ rejects payout when not all members have paid (7 ms)
    â”œÃ¹ allows payout when all members have paid at least contribution_amount (94 ms)

  Î“Ã¹Ã… ROSCA processPayout - contribution checks Î“Ã‡â•‘ allows payout when all members have paid at least contribution_amount

    expect(jest.fn()).not.toHaveBeenCalled()

    Expected number of calls: 0
    Received number of calls: 1

    1: 500

      299 |
      300 |     // On success, we use default 200 status with a JSON body
    > 301 |     expect(res.status).not.toHaveBeenCalled();
          |                            ^
      302 |     expect(res.json).toHaveBeenCalledWith(
      303 |       expect.objectContaining({
      304 |         success: true,

      at Object.toHaveBeenCalled (tests/roscaController.test.js:301:28)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

  console.error
    SERVER ERROR: Cannot read properties of undefined (reading 'query')

    [0m [90m 212 |[39m app[33m.[39muse((err[33m,[39m req[33m,[39m res[33m,[39m next) [33m=>[39m {
     [90m 213 |[39m   err[33m.[39mstatusCode [33m=[39m err[33m.[39mstatusCode [33m||[39m [35m500[39m[33m;[39m
    [31m[1m>[22m[39m[90m 214 |[39m   console[33m.[39merror([32m"SERVER ERROR:"[39m[33m,[39m err[33m.[39mmessage)[33m;[39m
     [90m     |[39m           [31m[1m^[22m[39m
     [90m 215 |[39m   logger[33m.[39merror({
     [90m 216 |[39m     message[33m:[39m err[33m.[39mmessage[33m,[39m
     [90m 217 |[39m     stack[33m:[39m err[33m.[39mstack[33m,[39m[0m

      at error (server.js:214:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at Layer.handleError (node_modules/router/lib/layer.js:111:12)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (controllers/ascaController.js:151:12)

POST /api/asca/1/buy-shares 500 68.197 ms - 10 - {"amount":1000,"paymentMethod":"mpesa"}
GET /api/asca/1/equity 200 2.366 ms - 10 - -
FAIL tests/ascaRoutes.int.test.js
  ASCA routes integration (/api/asca)
    â”œÃ¹ POST /api/asca/:chamaId/buy-shares creates a share purchase with normalized payment method (314 ms)
    Î“ÃªÃœ GET /api/asca/:chamaId/equity returns computed equity snapshot (35 ms)

  Î“Ã¹Ã… ASCA routes integration (/api/asca) Î“Ã‡â•‘ POST /api/asca/:chamaId/buy-shares creates a share purchase with normalized payment method

    expected 201 "Created", got 500 "Internal Server Error"

      132 |       .set('Authorization', 'Bearer fake-token')
      133 |       .send({ amount: 1000, paymentMethod: 'mpesa' })
    > 134 |       .expect(201);
          |        ^
      135 |
      136 |     expect(res.body.success).toBe(true);
      137 |     expect(res.body.data.sharePrice).toBe(100);

      at Object.expect (tests/ascaRoutes.int.test.js:134:8)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

POST /api/auth/register 201 285.796 ms - anonymous - {"email":"test1768841971880@example.com","password":"[REDACTED]","firstName":"Test","lastName":"User","phoneNumber":"0712345678"}
POST /api/auth/register 400 4.752 ms - anonymous - {"email":"test@example.com"}
POST /api/auth/register 400 2.502 ms - anonymous - {"email":"duplicate1768841972259@example.com","password":"[REDACTED]","firstName":"Test","lastName":"User","phoneNumber":"0712345678"}
  console.log
    Querying database for user: logintest1768841972282@example.com

      at log (controllers/authController.js:263:13)

  console.log
    Database query result: { rowCount: 1 }

      at log (controllers/authController.js:267:13)

POST /api/auth/login 200 32.589 ms - anonymous - {"email":"logintest1768841972282@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: logintest1768841972282@example.com

      at log (controllers/authController.js:263:13)

  console.log
    Database query result: { rowCount: 1 }

      at log (controllers/authController.js:267:13)

POST /api/auth/login 401 11.438 ms - anonymous - {"email":"logintest1768841972282@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: nonexistent@example.com

      at log (controllers/authController.js:263:13)

  console.log
    Database query result: { rowCount: 0 }

      at log (controllers/authController.js:267:13)

POST /api/auth/login 401 12.460 ms - anonymous - {"email":"nonexistent@example.com","password":"[REDACTED]"}
PASS tests/auth.test.js
  Authentication API
    POST /api/auth/register
      Î“ÃªÃœ should register a new user (342 ms)
      Î“ÃªÃœ should reject registration with missing fields (36 ms)
      Î“ÃªÃœ should reject duplicate email (23 ms)
    POST /api/auth/login
      Î“ÃªÃœ should login with correct credentials (68 ms)
      Î“ÃªÃœ should reject login with wrong password (31 ms)
      Î“ÃªÃœ should reject login with non-existent email (44 ms)
  Health Check API
    Î“ÃªÃœ should return health status (165 ms)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

GET /socket.io/?EIO=4&transport=websocket 200 17.786 ms - anonymous - -
PASS tests/socketAuth.test.js
  Socket.io authentication
    Î“ÃªÃœ rejects connection without token (170 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/authVerification.test.js
  Auth verification endpoints
    verifyEmail
      Î“ÃªÃœ rejects missing token (12 ms)
      Î“ÃªÃœ verifies email with valid token (1 ms)
    verifyPhone
      Î“ÃªÃœ rejects missing code (1 ms)
      Î“ÃªÃœ verifies phone with correct OTP and not expired (5 ms)
    resendEmailVerification
      Î“ÃªÃœ returns 404 when user not found (3 ms)
      Î“ÃªÃœ enforces cooldown when last sent recently (2 ms)
      Î“ÃªÃœ resends when outside cooldown window (2 ms)
    resendPhoneVerification
      Î“ÃªÃœ returns 404 when user not found (2 ms)
      Î“ÃªÃœ enforces cooldown when last SMS sent recently (2 ms)
      Î“ÃªÃœ resends OTP when outside cooldown window (17 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.error
    AUTH_REGISTER_ERROR: DB connection failed Error: DB connection failed
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:23:13)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:305:39
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:312:13)
        at Object.mockConstructor [as query] (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:102:19)
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:120:35)
        at Object.register (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:37:11)
        at Promise.finally.completed (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at runNextTicks (node:internal/process/task_queues:64:5)
        at processImmediate (node:internal/timers:472:9)
        at _runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:275:16)
        at runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 225 |[39m     })[33m;[39m
     [90m 226 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 227 |[39m     console[33m.[39merror([32m"AUTH_REGISTER_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 228 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 229 |[39m       context[33m:[39m [32m"auth_register"[39m[33m,[39m
     [90m 230 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:227:13)
      at Object.register (tests/authErrors.test.js:37:11)

  console.error
    AUTH_REGISTER_ERROR: DB connection failed Error: DB connection failed
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:48:13)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:305:39
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:312:13)
        at Object.mockConstructor [as query] (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:102:19)
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:120:35)
        at Object.register (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:62:11)
        at Promise.finally.completed (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at runNextTicks (node:internal/process/task_queues:64:5)
        at processImmediate (node:internal/timers:472:9)
        at _runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:275:16)
        at runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 225 |[39m     })[33m;[39m
     [90m 226 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 227 |[39m     console[33m.[39merror([32m"AUTH_REGISTER_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 228 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 229 |[39m       context[33m:[39m [32m"auth_register"[39m[33m,[39m
     [90m 230 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:227:13)
      at Object.register (tests/authErrors.test.js:62:11)

  console.log
    Querying database for user: login@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: DB connection failed Error: DB connection failed
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:73:13)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:305:39
        at Object.<anonymous> (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:312:13)
        at Object.mockConstructor [as query] (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-mock\build\index.js:102:19)
        at query (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:264:31)
        at Object.login (C:\Users\lewis\Desktop\chamasmart\backend\tests\authErrors.test.js:84:11)
        at Promise.finally.completed (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1557:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1497:10)
        at _callCircusTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1007:40)
        at runNextTicks (node:internal/process/task_queues:64:5)
        at processImmediate (node:internal/timers:472:9)
        at _runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:947:3)
        at C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:849:7
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:862:11)
        at _runTestsForDescribeBlock (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:857:11)
        at run (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:761:3)
        at runAndTransformResultsToJestFormat (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\jestAdapterInit.js:1918:21)
        at jestAdapter (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-circus\build\runner.js:101:19)
        at runTestInternal (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:275:16)
        at runTest (C:\Users\lewis\Desktop\chamasmart\backend\node_modules\jest-runner\build\index.js:343:7)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)
      at Object.login (tests/authErrors.test.js:84:11)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/authErrors.test.js
  Auth controller error handling
    Î“ÃªÃœ hides internal error details in production for register (97 ms)
    Î“ÃªÃœ includes error details in non-production for register (17 ms)
    Î“ÃªÃœ hides internal error details in production for login (98 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

GET /api/rosca/cycles/123/roster 403 4.506 ms - 999 - -
GET /api/rosca/cycles/123/roster 200 3.069 ms - 999 - -
PASS tests/roscaRoutes.int.test.js
  ROSCA routes integration - roster security
    Î“ÃªÃœ denies roster access for non-member (403) (307 ms)
    Î“ÃªÃœ authorized member can see roster without PII (no phone_number/trust_score) (103 ms)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

PASS tests/requestLogger.test.js
  Request Logger Middleware
    sanitizeBody
      Î“ÃªÃœ should redact password field (10 ms)
      Î“ÃªÃœ should redact multiple sensitive fields (1 ms)
      Î“ÃªÃœ should handle null/undefined body (1 ms)
    sanitizeHeaders
      Î“ÃªÃœ should partially redact authorization header (1 ms)
      Î“ÃªÃœ should redact cookie header

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/ascaController.test.js
  ASCA Controller - buyShares
    Î“ÃªÃœ rejects invalid payment method (6 ms)
    Î“ÃªÃœ creates share purchase with valid payment method and computes shares (11 ms)
  ASCA Controller - getMyEquity
    Î“ÃªÃœ computes equity based on total assets and shares (3 ms)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 96.882 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 32.517 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 41.296 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 67.951 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 39.710 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
POST /api/auth/register 400 3.258 ms - anonymous - {"email":"invalid-email","password":"[REDACTED]","name":"Test User"}
POST /api/auth/register 400 2.301 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]","name":"Test User"}
POST /api/auth/login 400 12.926 ms - anonymous - {"email":{"$ne":null},"password":"[REDACTED]"}
POST /api/chamas 401 4.784 ms - anonymous - {"name":"Test <script>alert(1)</script>","description":"Description <script>alert(1)</script>"}
PASS tests/security.test.js
  Security Middleware
    Rate Limiting
      Î“ÃªÃœ should allow requests under the rate limit (520 ms)
      Î“ÃªÃœ should block requests over the rate limit (1 ms)
    Security Headers
      Î“ÃªÃœ should include security headers (117 ms)
    Input Validation
      Î“ÃªÃœ should reject invalid email format (34 ms)
      Î“ÃªÃœ should reject weak passwords (28 ms)
    NoSQL Injection Protection
      Î“ÃªÃœ should sanitize NoSQL injection attempts (36 ms)
    XSS Protection
      Î“ÃªÃœ should sanitize XSS attempts in request body (101 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [TEST] Query: BEGIN

      at Object.log (tests/rosca_controller_fixed.test.js:44:15)

  console.log
    [TEST] Query: SELECT 1 FROM chama_members 
                 WHERE ch

      at Object.log (tests/rosca_controller_fixed.test.js:44:15)

  console.log
    [TEST] Query: INSERT INTO rosca_cycles 
                 (chama_id,

      at Object.log (tests/rosca_controller_fixed.test.js:44:15)

  console.log
    [TEST] Query: SELECT user_id FROM chama_members 
                 WH

      at Object.log (tests/rosca_controller_fixed.test.js:44:15)

  console.log
    [TEST] Query: INSERT INTO rosca_roster (cycle_id, user_id, posit

      at Object.log (tests/rosca_controller_fixed.test.js:44:15)

  console.log
    [TEST] Query: COMMIT

      at Object.log (tests/rosca_controller_fixed.test.js:44:15)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/rosca_controller_fixed.test.js
  ROSCA createCycle - parameterized roster insert
    Î“ÃªÃœ uses parameterized VALUES and correct payout amounts (41 ms)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

      at _log (node_modules/dotenv/lib/main.js:142:11)

PASS tests/proposalController.test.js
  ProposalController.castVote - membership-checked voting
    Î“ÃªÃœ rejects vote from non-member (4 ms)
    Î“ÃªÃœ allows member to vote once and rejects duplicate votes (2 ms)

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

PASS tests/metrics.test.js
  /metrics protection
    Î“ÃªÃœ rejects unauthorized metrics access when token is set in production (294 ms)
    Î“ÃªÃœ allows metrics access with correct token in production (126 ms)

Test Suites: 2 failed, 11 passed, 13 total
Tests:       2 failed, 46 passed, 48 total
Snapshots:   0 total
Time:        51.979 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
