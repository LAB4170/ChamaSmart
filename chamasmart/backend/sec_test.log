
> chamasmart-backend@1.0.0 test
> jest --runInBand tests/security.test.js --no-coverage

  console.log
    [dotenv@17.2.3] injecting env (3) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    [MOCK] Loading mocked database

      at Object.log (config/__mocks__/db.js:2:9)

  console.log
    STABILIZED: Server running on port 5005

      at Server.log (server.js:235:11)

  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 122.448 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 21.107 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 13.826 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 11.198 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
  console.log
    Querying database for user: test@example.com

      at log (controllers/authController.js:263:13)

  console.error
    AUTH_LOGIN_ERROR: Cannot read properties of undefined (reading 'rows') TypeError: Cannot read properties of undefined (reading 'rows')
        at rows (C:\Users\lewis\Desktop\chamasmart\backend\controllers\authController.js:267:62)
        at processTicksAndRejections (node:internal/process/task_queues:103:5)

    [0m [90m 318 |[39m     })[33m;[39m
     [90m 319 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 320 |[39m     console[33m.[39merror([32m"AUTH_LOGIN_ERROR:"[39m[33m,[39m error[33m.[39mmessage[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 321 |[39m     logger[33m.[39mlogError(error[33m,[39m {
     [90m 322 |[39m       context[33m:[39m [32m"auth_login"[39m[33m,[39m
     [90m 323 |[39m       email[33m:[39m req[33m.[39mbody[33m?[39m[33m.[39memail[33m,[39m[0m

      at error (controllers/authController.js:320:13)

POST /api/auth/login 500 13.671 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]"}
POST /api/auth/register 400 4.328 ms - anonymous - {"email":"invalid-email","password":"[REDACTED]","name":"Test User"}
POST /api/auth/register 400 3.335 ms - anonymous - {"email":"test@example.com","password":"[REDACTED]","name":"Test User"}
POST /api/auth/login 400 0.887 ms - anonymous - {"email":{"$ne":null},"password":"[REDACTED]"}
POST /api/chamas 401 3.000 ms - anonymous - {"name":"Test <script>alert(1)</script>","description":"Description <script>alert(1)</script>"}
FAIL tests/security.test.js (30.095 s)
  Security Middleware
    Rate Limiting
      Î“ÃªÃœ should allow requests under the rate limit (479 ms)
      Î“ÃªÃœ should block requests over the rate limit (1 ms)
    Security Headers
      â”œÃ¹ should include security headers (19 ms)
    Input Validation
      â”œÃ¹ should reject invalid email format (16 ms)
      Î“ÃªÃœ should reject weak passwords (11 ms)
    NoSQL Injection Protection
      Î“ÃªÃœ should sanitize NoSQL injection attempts (6 ms)
    XSS Protection
      Î“ÃªÃœ should sanitize XSS attempts in request body (10 ms)

  Î“Ã¹Ã… Security Middleware Î“Ã‡â•‘ Security Headers Î“Ã‡â•‘ should include security headers

    expect(received).toBe(expected) // Object.is equality

    Expected: "off"
    Received: undefined

      62 |       const response = await request(server).get("/health");
      63 |
    > 64 |       expect(response.headers["x-dns-prefetch-control"]).toBe("off");
         |                                                          ^
      65 |       expect(response.headers["x-frame-options"]).toBe("DENY");
      66 |       expect(response.headers["strict-transport-security"]).toBeDefined();
      67 |       expect(response.headers["x-download-options"]).toBe("noopen");

      at Object.toBe (tests/security.test.js:64:58)

  Î“Ã¹Ã… Security Middleware Î“Ã‡â•‘ Input Validation Î“Ã‡â•‘ should reject invalid email format

    expect(received).toHaveProperty(path, value)

    Expected path: "message"

    Expected value: "Validation failed"
    Received value: "Validation error"

      82 |       expect(response.status).toBe(400);
      83 |       expect(response.body).toHaveProperty("success", false);
    > 84 |       expect(response.body).toHaveProperty("message", "Validation failed");
         |                             ^
      85 |     });
      86 |
      87 |     it("should reject weak passwords", async () => {

      at Object.toHaveProperty (tests/security.test.js:84:29)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 5 passed, 7 total
Snapshots:   0 total
Time:        30.88 s
Ran all test suites matching tests/security.test.js.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
